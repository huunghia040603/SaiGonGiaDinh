{% extends 'base.html' %}

{% block content %}
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container7">
        <h1 style="font-family: 'Courier New', Courier, monospace;"><i class="fas fa-user-graduate" ></i> Thông tin Sinh viên</h1>
        
        <div id="student-info">
            <p class="loading7">Đang tải thông tin...</p>
        </div>

        <div id="error-message" class="error-message7" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span class="error-text"></span>
        </div>

        <div id="login-required" class="login-prompt7" style="display: none;">
            <i class="fas fa-lock"></i>
            <p>Bạn chưa đăng nhập. Vui lòng <a href="/login.html">đăng nhập</a> để xem thông tin.</p>
        </div>

        <div class="logout-button-container7">
            <button id="logoutBtn" style="display: none;">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>
    </div>

    <script>
        const API_URL = "https://saigongiadinh.pythonanywhere.com/Students/me/";
        const LOGIN_PAGE_URL = "/"; 
        const LOGOUT_API_URL = "https://saigongiadinh.pythonanywhere.com/auth/logout/";

        async function fetchStudentInfo() {
            const studentInfoDiv = document.getElementById('student-info');
            const errorMessageDiv = document.getElementById('error-message');
            const loginRequiredDiv = document.getElementById('login-required');
            const logoutBtn = document.getElementById('logoutBtn');
            const containerDiv = document.querySelector('.container7');

            const authToken = localStorage.getItem('authToken');

            if (containerDiv) {
                containerDiv.classList.add('fade-in-container7');
            }

            if (!authToken) {
                studentInfoDiv.innerHTML = '';
                loginRequiredDiv.style.display = 'flex';
                logoutBtn.style.display = 'none'; 
                return;
            }

            logoutBtn.style.display = 'block';
            studentInfoDiv.innerHTML = '<p class="loading7">Đang tải thông tin...</p>';
            errorMessageDiv.style.display = 'none';
            loginRequiredDiv.style.display = 'none';

            const loadingParagraph = studentInfoDiv.querySelector('.loading7');
            if (loadingParagraph) {
                loadingParagraph.classList.remove('hide7');
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${authToken}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        handleLogout("Phiên đăng nhập đã hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.");
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Lỗi khi tải thông tin: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                displayStudentInfo(data);

            } catch (error) {
                console.error("Lỗi khi fetch thông tin sinh viên:", error);
                studentInfoDiv.innerHTML = '';
                errorMessageDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <span class="error-text">Lỗi: ${error.message}</span>
                `;
                errorMessageDiv.style.display = 'flex';
            } finally {
                const finalLoadingParagraph = studentInfoDiv.querySelector('.loading7');
                if (finalLoadingParagraph) {
                    finalLoadingParagraph.classList.add('hide7');
                }
            }
        }

        function displayStudentInfo(student) {
            const studentInfoDiv = document.getElementById('student-info');
            const loadingParagraph = studentInfoDiv.querySelector('.loading7');
            if (loadingParagraph) {
                loadingParagraph.classList.add('hide7');
            }

            studentInfoDiv.innerHTML = `
                <div class="profile-header7">
                    <img src="https://res.cloudinary.com/dftarzzfw/${student.user_photo || 'default-avatar.png'}" 
                         alt="${student.full_name || 'Ảnh đại diện'}" 
                         class="profile-avatar7" 
                         id="profile-avatar7"
                         onerror="this.src='/static/images/default-avatar.png'">
                    <h2 id="student-name7">${student.full_name || 'N/A'}</h2>
                    <p id="student-id7"><i class="fas fa-id-card"></i> ${student.student_code || 'N/A'}</p>
                </div>
                <div class="profile-details7">
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fas fa-envelope"></i> Email</span>
                        <span class="detail-value7" id="student-email7">${student.email || 'N/A'}</span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fas fa-user"></i> Họ</span>
                        <span class="detail-value7" id="student-lastname7">${student.last_name || 'N/A'}</span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fas fa-user-circle"></i> Tên đệm & Tên</span>
                        <span class="detail-value7" id="student-firstname7">${student.first_name || 'N/A'}</span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fa-solid fa-cake-candles"></i>Ngày sinh</span>
                        <span class="detail-value7" id="student-firstname7">
                            ${
                                student.date_of_birth
                                    ? new Date(student.date_of_birth).toLocaleDateString('vi-VN', {
                                        day: '2-digit',
                                        month: '2-digit',
                                        year: 'numeric',
                                    })
                                    : 'N/A'
                            }
                        </span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fa-solid fa-briefcase"></i> Khoa</span>
                        <span class="detail-value7" id="student-firstname7">${student.department_name || 'N/A'}</span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fa-solid fa-chalkboard"></i>Ngành</span>
                        <span class="detail-value7" id="student-firstname7">${student.major_name || 'N/A'}</span>
                    </div>
                    
                   <div class="detail-item7">
                        <span class="detail-label7"><i class="fa-solid fa-box-archive"></i>Hệ đào tạo</span>
                        <span class="detail-value7" id="student-firstname7">
                            ${
                                (() => {
                                    switch (student.program_name) {
                                        case 'CHINH_QUY':
                                            return 'CHÍNH QUY';
                                        case 'PHO_THONG_CAO_DANG':
                                            return 'Phổ thông cao đẳng 9+';
                                        case 'LIEN_THONG_VAN_BANG_2_CAO_DANG':
                                            return 'Liên thông/Văn bằng 2 cao đẳng';
                                        case 'LIEN_THONG_VAN_BANG_2_DAI_HOC':
                                            return 'Liên thông/Văn bằng 2 đại học';
                                        default:
                                            return student.program_name || 'N/A';
                                    }
                                })()
                            }
                        </span>
                    </div>
                    <div class="detail-item7">
                        <span class="detail-label7"><i class="fa-solid fa-graduation-cap"></i>Niên khóa</span>
                        <span class="detail-value7" id="student-firstname7">${student.academic_year_name || 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        async function handleLogout(message = "Đã đăng xuất thành công.") {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userFullName');

            const authToken = localStorage.getItem('authToken'); 
            if (authToken) { 
                try {
                    await fetch(LOGOUT_API_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${authToken}`
                        }
                    });
                    console.log('Token invalidated on server.');
                } catch (error) {
                    console.error('Lỗi khi gửi yêu cầu logout tới server:', error);
                }
            }
            alert(message);
            window.location.href = LOGIN_PAGE_URL;
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchStudentInfo();

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            const loginPromptLink = document.querySelector('#login-required a');
            if (loginPromptLink) {
                loginPromptLink.href = LOGIN_PAGE_URL;
            }
        });
    </script>
</body>
{% endblock %}